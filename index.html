<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>RepZone Tracker V2</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://sea.refinedpainting.co/js/form_embed.js" type="text/javascript"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif; }
  
  #map-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
  #map { width: 100%; height: 100%; }
  
  .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
  @keyframes progress { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
  
  .tracking-indicator { animation: pulse 2s infinite; }
  .tab { padding: 0.875rem 1.25rem; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; transition: all 0.3s; font-size: 0.9375rem; }
  .tab.active { border-bottom-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
  .tab:hover { background: #f1f5f9; }
  .toast { position: fixed; top: 5rem; right: 1rem; background: white; padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 10001; animation: slideIn 0.3s ease; max-width: 400px; border-left: 4px solid #3b82f6; }
  
  .stat-card { background: white; border-radius: 1rem; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.3s; border: 1px solid #e5e7eb; }
  .stat-card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }
  .modern-button { transition: all 0.2s; font-weight: 600; cursor: pointer; }
  .modern-button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .modern-button:active { transform: translateY(0); }
  .loading-shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 1000px 100%; animation: shimmer 2s infinite; }
  
  .hamburger-btn { display: none; position: fixed; top: 1rem; left: 1rem; width: 54px; height: 54px; background: white; border: none; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; z-index: 1002; flex-direction: column; align-items: center; justify-content: center; gap: 5px; transition: all 0.3s; }
  .hamburger-btn:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
  .hamburger-btn span { width: 26px; height: 3px; background: #1e293b; border-radius: 2px; transition: all 0.3s; }
  .hamburger-btn.open span:nth-child(1) { transform: rotate(45deg) translate(6px, 6px); }
  .hamburger-btn.open span:nth-child(2) { opacity: 0; }
  .hamburger-btn.open span:nth-child(3) { transform: rotate(-45deg) translate(6px, -6px); }
  
  .mobile-dropdown { display: none; position: fixed; top: 0; left: 0; right: 0; background: white; max-height: 0; overflow: hidden; transition: max-height 0.4s ease; z-index: 1001; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .mobile-dropdown.open { max-height: 85vh; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .desktop-sidebar { display: flex; position: fixed; top: 1rem; left: 1rem; width: 420px; max-height: calc(100vh - 2rem); z-index: 1000; }
  
  @media (max-width: 768px) {
    .hamburger-btn { display: flex; }
    .mobile-dropdown { display: block; }
    .desktop-sidebar { display: none !important; }
    .toast { left: 1rem; right: 1rem; top: 1rem; }
  }
  
  @media (min-width: 769px) {
    .hamburger-btn { display: none !important; }
    .mobile-dropdown { display: none !important; }
    .desktop-sidebar { display: flex !important; }
  }
  
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #f1f5f9; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

  .recenter-btn { position: fixed; bottom: 180px; right: 20px; width: 56px; height: 56px; background: white; border: 2px solid #3b82f6; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s; }
  .recenter-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
  .compass-btn { position: fixed; bottom: 110px; right: 20px; width: 56px; height: 56px; background: white; border: 2px solid #f59e0b; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; transition: all 0.3s; }
  .compass-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }

  .mode-btn { padding: 0.875rem 1.25rem; border-radius: 0.75rem; border: 3px solid transparent; cursor: pointer; text-align: center; transition: all 0.2s; font-weight: 600; font-size: 0.9375rem; }
  .mode-btn.active { border-color: #3b82f6; background: #eff6ff; color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
  .mode-btn:hover { background: #f8fafc; }
  
  .user-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: white; border-radius: 1rem; margin-bottom: 0.75rem; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s; position: relative; }
  .user-card:hover { border-color: #3b82f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.2); }
  
  .user-menu { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); }
  .user-menu-btn { padding: 0.5rem; background: #f1f5f9; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1.25rem; line-height: 1; }
  .user-menu-btn:hover { background: #e2e8f0; }
  
  .dropdown-menu { position: absolute; right: 0; top: 100%; margin-top: 0.5rem; background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 0.5rem; min-width: 150px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 100; animation: fadeIn 0.2s ease; }
  .dropdown-item { padding: 0.75rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600; font-size: 0.875rem; transition: all 0.2s; }
  .dropdown-item:hover { background: #f1f5f9; }
  
  .lead-type-btn { padding: 1.5rem 1rem; border-radius: 0.875rem; border: 3px solid transparent; cursor: pointer; transition: all 0.2s; text-align: center; font-weight: 600; }
  .lead-type-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
  .lead-type-btn.active { border-color: white; box-shadow: 0 0 0 3px rgba(255,255,255,0.2); }
  
  .zone-item { padding: 0.875rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s; }
  .zone-item:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(4px); }
  .zone-item.active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.2); }
  
  .leaderboard-item { display: flex; align-items: center; gap: 0.875rem; padding: 0.875rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; margin-bottom: 0.5rem; transition: all 0.2s; }
  .leaderboard-item:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(4px); }
  
  .rank-badge { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; }
  .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
  .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); }
  .rank-3 { background: linear-gradient(135deg, #fb923c, #f97316); }
  
  .filter-btn { padding: 0.625rem 1rem; border-radius: 0.5rem; border: 2px solid #e5e7eb; cursor: pointer; font-weight: 600; font-size: 0.875rem; transition: all 0.2s; background: white; }
  .filter-btn.active { border-color: #3b82f6; background: #eff6ff; color: #3b82f6; }
  .filter-btn:hover { border-color: #3b82f6; }
  
  .search-input { width: 100%; padding: 0.875rem 1rem; border-radius: 0.75rem; border: 2px solid #e5e7eb; font-size: 0.9375rem; transition: all 0.2s; }
  .search-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
  
  .search-result { padding: 0.75rem; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; }
  .search-result:hover { background: #eff6ff; border-color: #3b82f6; }
  
  .input-field { width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.9375rem; font-weight: 600; transition: all 0.2s; }
  .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
  
  .textarea-field { width: 100%; padding: 0.875rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; font-size: 0.9375rem; font-weight: 600; resize: vertical; font-family: -apple-system, sans-serif; transition: all 0.2s; }
  .textarea-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
  
  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10003; padding: 1rem; animation: fadeIn 0.2s ease; }
  .modal-content { background: white; border-radius: 1.5rem; padding: 2rem; max-width: 440px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); animation: fadeIn 0.3s ease; max-height: 90vh; overflow-y: auto; }
  .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
  .modal-title { fontSize: 1.5rem; font-weight: bold; color: #1e293b; }
  .modal-close { width: 40px; height: 40px; borderRadius: 50%; border: none; background: #f1f5f9; fontSize: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
  .modal-close:hover { background: #e2e8f0; }
  
  .label-text { display: block; fontSize: 0.9375rem; font-weight: 700; margin-bottom: 0.5rem; color: #1e293b; }
  .label-optional { color: #64748b; font-weight: 400; }
  
  .btn-primary { width: 100%; padding: 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.75rem; fontSize: 1rem; font-weight: 700; box-shadow: 0 4px 12px rgba(59,130,246,0.3); transition: all 0.2s; cursor: pointer; }
  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 6px 16px rgba(59,130,246,0.4); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
  
  .btn-secondary { padding: 1rem; background: #e5e7eb; color: #1e293b; border: none; border-radius: 0.75rem; fontSize: 1rem; font-weight: 700; transition: all 0.2s; cursor: pointer; }
  .btn-secondary:hover { background: #d1d5db; }
  
  .loading-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; padding: 2rem 2.5rem; border-radius: 1.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.2); z-index: 10001; display: flex; flex-direction: column; gap: 1rem; align-items: center; }
  .loading-text { font-weight: 700; fontSize: 1.125rem; color: #1e293b; }
  
  .gps-indicator { padding: 1rem; background: #d1fae5; borderRadius: 1rem; border: 2px solid #10b981; margin-top: 1rem; }
  .gps-indicator.stale { background: #fef3c7; border-color: #f59e0b; }
  .gps-indicator-content { display: flex; align-items: center; gap: 0.75rem; }
  .gps-dot { width: 12px; height: 12px; background: #10b981; borderRadius: 50%; }
  .gps-dot.stale { background: #f59e0b; }
  .gps-status { font-weight: 700; fontSize: 0.9375rem; color: #1e293b; }
  .gps-details { fontSize: 0.8125rem; color: #64748b; }
</style>
</head>
<body>
<div id="map-container"><div id="map"></div></div>
<div id="root"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxqGzPnCxZNpH3Xopsk4VnwZOxVLjSQWc&libraries=places,geometry"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

const SUPABASE_URL = 'https://cfkkxkvfekjdnwwngtzd.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNma2t4a3ZmZWtqZG53d25ndHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MjQ3NTYsImV4cCI6MjA4MDMwMDc1Nn0.VlAsOfeSLXzajiH7CUyXWlV9hyL68D_F3yYg1R-jcIk';

const ADMIN_IDS = ['user-1760858671762', 'user-1760855853315'];

const COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899"];

const LEAD_TYPES = {
  estimate: { icon: 'üí∞', label: 'A - Estimate', color: '#10b981', display: 'A' },
  callback: { icon: 'üìû', label: 'B - Callback 1-2 Weeks', color: '#f59e0b', display: 'B' },
  notinterested: { icon: 'üìã', label: 'C - Not Interested (Has Info)', color: '#64748b', display: 'C' },
  flyer: { icon: 'üì¨', label: 'FD - Flyer Drop', color: '#3b82f6', display: 'FD' },
  knocked: { icon: '‚úÖ', label: 'Knocked', color: '#16a34a', display: '‚úÖ' },
  skipped: { icon: '‚è≠Ô∏è', label: 'Skipped', color: '#ef4444', display: '‚è≠Ô∏è' }
};

const GPS_MAX_AGE_MS = 30000;

const GHL_CONFIG = {
  apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6ImVuMmQ4Q2FxR0Q4YTNTRUNNSEY4eiIsImNvbXBhbnlfaWQiOiJPY3JQM2ljTW5tcTlXSkxLRkhvTSIsInZlcnNpb24iOjEsImlhdCI6MTczNDg0NjI5NDUzOCwic3ViIjoiSGZ5Y045M1RsN3VHckFQZ2l2MjQifQ.m7c5fHpJldhJLwp14cA0XOmRNgEbnGJy5ufQxCiujRA',
  locationId: 'en2d8CaqGD8a3SEMVFHz',
  calendarUrls: { 
    onsite: 'https://sea.refinedpainting.co/widget/bookings/onsiteestimates', 
    general: 'https://sea.refinedpainting.co/widget/booking/fIYuXbwwo4XQh3nyLxj8' 
  }
};

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const œÜ1 = lat1 * Math.PI / 180;
  const œÜ2 = lat2 * Math.PI / 180;
  const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
  const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c * 3.28084;
}

function getVerificationStatus(distance) {
  if (distance <= 50) return { status: 'verified', color: '#10b981', icon: '‚úÖ', label: 'Verified' };
  if (distance <= 150) return { status: 'questionable', color: '#f59e0b', icon: '‚ö†Ô∏è', label: 'Questionable' };
  return { status: 'suspicious', color: '#ef4444', icon: 'üö´', label: 'Suspicious' };
}

function isPointInPolygon(point, polygon) {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i].lng, yi = polygon[i].lat;
    const xj = polygon[j].lng, yj = polygon[j].lat;
    const intersect = ((yi > point.lat) !== (yj > point.lat)) && (point.lng < (xj - xi) * (point.lat - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function isGPSFresh(location) {
  if (!location || !location.timestamp) return false;
  return (Date.now() - location.timestamp) < GPS_MAX_AGE_MS;
}

function getGPSAge(location) {
  if (!location || !location.timestamp) return null;
  return Math.floor((Date.now() - location.timestamp) / 1000);
}

async function reverseGeocode(lat, lng) {
  try {
    const geocoder = new google.maps.Geocoder();
    const response = await geocoder.geocode({ location: { lat, lng } });
    
    if (response.results && response.results.length > 0) {
      const result = response.results[0];
      const addressComponents = result.address_components;
      
      let houseNumber = '', street = '', city = '', state = '', postcode = '', suburb = '';
      
      addressComponents.forEach(component => {
        if (component.types.includes('street_number')) houseNumber = component.long_name;
        if (component.types.includes('route')) street = component.long_name;
        if (component.types.includes('locality')) city = component.long_name;
        if (component.types.includes('sublocality') || component.types.includes('neighborhood')) suburb = component.long_name;
        if (component.types.includes('administrative_area_level_1')) state = component.short_name;
        if (component.types.includes('postal_code')) postcode = component.long_name;
      });
      
      const fullAddress = result.formatted_address;
      const shortAddress = houseNumber && street ? `${houseNumber} ${street}` : street || suburb || city || 'Unknown';
      
      return { 
        fullAddress, 
        shortAddress, 
        houseNumber, 
        street, 
        suburb, 
        city, 
        state, 
        postcode, 
        lat: result.geometry.location.lat(), 
        lng: result.geometry.location.lng(), 
        displayName: result.formatted_address 
      };
    }
    return null;
  } catch (error) {
    console.error('Geocoding error:', error);
    return null;
  }
}

async function forwardGeocode(query) {
  try {
    const service = new google.maps.places.AutocompleteService();
    const request = { 
      input: query, 
      types: ['address'], 
      componentRestrictions: { country: 'us' } 
    };
    
    return new Promise((resolve) => {
      service.getPlacePredictions(request, (predictions, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
          resolve(predictions.map(p => ({ 
            displayName: p.description, 
            placeId: p.place_id 
          })));
        } else {
          resolve([]);
        }
      });
    });
  } catch (error) {
    return [];
  }
}

async function getPlaceDetails(placeId) {
  return new Promise((resolve, reject) => {
    const service = new google.maps.places.PlacesService(document.createElement('div'));
    service.getDetails({ placeId }, (place, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK && place) {
        resolve({ 
          lat: place.geometry.location.lat(), 
          lng: place.geometry.location.lng() 
        });
      } else {
        reject(new Error('Place details not found'));
      }
    });
  });
}

async function sendContactToGHL(contactData) {
  try {
    const response = await fetch('https://rest.gohighlevel.com/v1/contacts/', {
      method: 'POST',
      headers: { 
        'Authorization': `Bearer ${GHL_CONFIG.apiKey}`, 
        'Content-Type': 'application/json', 
        'Version': '2021-07-28' 
      },
      body: JSON.stringify({
        locationId: GHL_CONFIG.locationId,
        firstName: contactData.name?.split(' ')[0] || contactData.name,
        lastName: contactData.name?.split(' ').slice(1).join(' ') || '',
        name: contactData.name,
        email: contactData.email || '',
        phone: contactData.phone || '',
        address1: contactData.address || '',
        tags: [
          'Door-to-Door', 
          contactData.leadType || 'Unknown', 
          contactData.verified ? 'GPS-Verified' : 'Unverified'
        ],
        source: 'RepZone App',
        customField: { 
          rep_name: contactData.repName, 
          lead_type: contactData.leadType, 
          gps_distance: contactData.distance, 
          pin_created_at: contactData.createdAt 
        }
      })
    });
    
    if (!response.ok) throw new Error(`GHL API error: ${response.status}`);
    return await response.json();
  } catch (error) {
    console.error('‚ùå Failed to send to GHL:', error);
    throw error;
  }
}

function openGHLCalendar(customerName, customerEmail, customerPhone, address) {
  if (window.showCalendarModal) {
    window.showCalendarModal({ 
      name: customerName || '', 
      email: customerEmail || '', 
      phone: customerPhone || '', 
      address: address || '' 
    });
  }
}

function RepZoneApp() {
  const [pins, setPins] = useState([]);
  const [zones, setZones] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);
  const [liveLocations, setLiveLocations] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [currentLocation, setCurrentLocation] = useState(null);
  const [mode, setMode] = useState("drop-pin");
  const [status, setStatus] = useState("estimate");
  const [activeZoneId, setActiveZoneId] = useState(null);
  const [selectedZone, setSelectedZone] = useState(null);
  const [note, setNote] = useState("");
  const [filter, setFilter] = useState({ status: "all", userId: "all" });
  const [activeTab, setActiveTab] = useState("map");
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [mapReady, setMapReady] = useState(false);
  const [showUserModal, setShowUserModal] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [newUserName, setNewUserName] = useState("");
  const [newUserRole, setNewUserRole] = useState("rep");
  const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
  const [leaderboardPeriod, setLeaderboardPeriod] = useState('week');
  const [leaderboardType, setLeaderboardType] = useState('d2d');
  const [trackingEnabled, setTrackingEnabled] = useState(false);
  const [showLiveTracking, setShowLiveTracking] = useState(true);
  const [toastMessage, setToastMessage] = useState(null);
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [geocoding, setGeocoding] = useState(false);
  const [addressSearch, setAddressSearch] = useState("");
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  const [showCustomerForm, setShowCustomerForm] = useState(false);
  const [customerName, setCustomerName] = useState('');
  const [customerPhone, setCustomerPhone] = useState('');
  const [customerEmail, setCustomerEmail] = useState('');
  const [customerNote, setCustomerNote] = useState('');
  const [showCalendarModal, setShowCalendarModal] = useState(false);
  const [calendarData, setCalendarData] = useState(null);
  const [pendingPinLocation, setPendingPinLocation] = useState(null);
  const [fdMode, setFdMode] = useState(false);
  const [assignedZones, setAssignedZones] = useState([]);
  const [mapHeading, setMapHeading] = useState(0);
  const [zonePoints, setZonePoints] = useState([]);

  const mapInstanceRef = useRef(null);
  const supabase = useRef(null);
  const locationWatchId = useRef(null);
  const locationUpdateInterval = useRef(null);
  const searchTimeoutRef = useRef(null);
  const markersRef = useRef([]);
  const userMarkerRef = useRef(null);
  const zonePolygonsRef = useRef([]);
  const liveMarkersRef = useRef([]);
  const drawingPolygonRef = useRef(null);

  async function setSupabaseUser(userId) {
    if (!userId || !supabase.current) return;
    try {
      await supabase.current.rpc('set_current_user', { user_id: userId });
    } catch (e) {
      console.error('Error setting user context:', e);
    }
  }

  function handleModeChange(newMode) {
    if (mode === "draw-zone" && newMode !== "draw-zone") {
      setActiveZoneId(null);
      setZonePoints([]);
      if (drawingPolygonRef.current) {
        drawingPolygonRef.current.setMap(null);
        drawingPolygonRef.current = null;
      }
    }
    setMode(newMode);
  }

  function showToast(message, duration = 4000) {
    setToastMessage(message);
    setTimeout(() => setToastMessage(null), duration);
  }

  useEffect(() => {
    const handleResize = () => setIsMobile(window.innerWidth < 768);
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  useEffect(() => {
    supabase.current = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    loadData();
    
    const saved = localStorage.getItem('current_user_id');
    if (saved) {
      try {
        const user = JSON.parse(saved);
        
        // Verify user exists in database
        supabase.current.from('team_members')
          .select('*')
          .eq('id', user.id)
          .single()
          .then(({ data, error }) => {
            if (data) {
              setCurrentUser(data);
              requestLocationPermission(data);
            } else if (error) {
              console.error('User not found in database:', error);
              localStorage.removeItem('current_user_id');
            }
          });
      } catch (e) {
        console.error('Error loading saved user:', e);
      }
    } else {
      // Check for current location to enable map centering
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          setCurrentLocation({ 
            lat: position.coords.latitude, 
            lng: position.coords.longitude, 
            timestamp: Date.now() 
          });
        });
      }
    }
  }, []);

  useEffect(() => {
    if (currentUser && teamMembers.length > 0) {
      const updatedUser = teamMembers.find(m => m.id === currentUser.id);
      if (updatedUser && updatedUser.role !== currentUser.role) {
        setCurrentUser(updatedUser);
        localStorage.setItem('current_user_id', JSON.stringify(updatedUser));
      }
    }
  }, [teamMembers, currentUser]);

  useEffect(() => {
    if (!supabase.current) return;
    loadLiveLocations();
    const interval = setInterval(loadLiveLocations, 10000);
    return () => clearInterval(interval);
  }, []);

  async function loadLiveLocations() {
    try {
      const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      const { data, error } = await supabase.current
        .from('live_locations')
        .select('*')
        .gte('last_updated', fiveMinutesAgo)
        .eq('is_active', true);
      
      if (!error && data) setLiveLocations(data);
    } catch (e) {
      console.error('Error loading live locations:', e);
    }
  }

  async function requestLocationPermission(user) {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(() => startLocationTracking(user));
  }

  function startLocationTracking(user) {
    if (!user || locationWatchId.current) return;
    setTrackingEnabled(true);
    
    locationWatchId.current = navigator.geolocation.watchPosition(
      (position) => {
        setCurrentLocation({ 
          lat: position.coords.latitude, 
          lng: position.coords.longitude, 
          accuracy: position.coords.accuracy, 
          heading: position.coords.heading, 
          timestamp: Date.now() 
        });
      }, 
      (error) => {
        console.error('Location tracking error:', error);
      }, 
      { enableHighAccuracy: true, maximumAge: 10000, timeout: 5000 }
    );
    
    locationUpdateInterval.current = setInterval(() => {
      if (currentLocation && user) updateLiveLocation(user.id, currentLocation);
    }, 30000);
  }

  function stopLocationTracking() {
    if (locationWatchId.current) {
      navigator.geolocation.clearWatch(locationWatchId.current);
      locationWatchId.current = null;
    }
    if (locationUpdateInterval.current) {
      clearInterval(locationUpdateInterval.current);
      locationUpdateInterval.current = null;
    }
    setTrackingEnabled(false);
    if (currentUser) updateLiveLocationInactive(currentUser.id);
  }

  async function updateLiveLocation(userId, location) {
    try {
      await setSupabaseUser(userId);
      await supabase.current.from('live_locations').upsert({ 
        team_member_id: userId, 
        lat: location.lat, 
        lng: location.lng, 
        accuracy: location.accuracy, 
        last_updated: new Date().toISOString(), 
        is_active: true 
      }, { onConflict: 'team_member_id' });
      
      loadLiveLocations();
    } catch (e) {
      console.error('Error updating live location:', e);
    }
  }

  async function updateLiveLocationInactive(userId) {
    try {
      await setSupabaseUser(userId);
      await supabase.current
        .from('live_locations')
        .update({ is_active: false })
        .eq('team_member_id', userId);
    } catch (e) {
      console.error('Error marking location inactive:', e);
    }
  }

  useEffect(() => {
    if (currentLocation && currentUser && trackingEnabled) {
      updateLiveLocation(currentUser.id, currentLocation);
    }
  }, [currentLocation, currentUser, trackingEnabled]);

  useEffect(() => () => stopLocationTracking(), []);

  async function loadData() {
    try {
      const [pinsRes, zonesRes, teamRes, assignedZonesRes] = await Promise.all([
        supabase.current.from('pins').select('*').order('created_at', { ascending: false }),
        supabase.current.from('zones').select('*'),
        supabase.current.from('team_members').select('*').order('role', { ascending: true }),
        supabase.current.from('assigned_zones').select('*').is('deleted_at', null)
      ]);
      
      setPins(pinsRes.data || []);
      setZones(zonesRes.data || []);
      setTeamMembers(teamRes.data || []);
      setAssignedZones(assignedZonesRes.data || []);
    } catch (e) {
      console.error('Error loading data:', e);
    }
    setLoading(false);
  }

  async function deletePin(pinId) {
    if (!confirm('Delete this pin?')) return;
    if (!currentUser) return;
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('pins').delete().eq('id', pinId);
      setPins(prev => prev.filter(p => p.id !== pinId));
      showToast('‚úÖ Pin deleted successfully!');
    } catch (e) {
      showToast('‚ùå Error deleting pin: ' + e.message);
    }
  }

  async function updatePinStatus(pinId, newStatus) {
    if (!currentUser) return;
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('pins').update({ status: newStatus }).eq('id', pinId);
      setPins(prev => prev.map(p => p.id === pinId ? {...p, status: newStatus} : p));
      showToast(`‚úÖ Updated to ${LEAD_TYPES[newStatus]?.label || newStatus}!`);
    } catch (e) {
      showToast('‚ùå Error updating pin: ' + e.message);
    }
  }

  async function deleteUser(userId) {
    if (!confirm('Delete this user? All their pins will remain.')) return;
    
    if (!ADMIN_IDS.includes(currentUser?.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can delete users!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').delete().eq('id', userId);
      setTeamMembers(prev => prev.filter(u => u.id !== userId));
      if (currentUser?.id === userId) setCurrentUser(null);
      setEditingUser(null);
      showToast('‚úÖ User deleted!');
    } catch (e) {
      showToast('‚ùå Error deleting user: ' + e.message);
    }
  }

  async function updateUserRole(userId, newRole) {
    if (!ADMIN_IDS.includes(currentUser?.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can change roles!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('team_members').update({ role: newRole }).eq('id', userId);
      setTeamMembers(prev => prev.map(u => u.id === userId ? {...u, role: newRole} : u));
      
      if (currentUser?.id === userId) {
        const updatedUser = {...currentUser, role: newRole};
        setCurrentUser(updatedUser);
        localStorage.setItem('current_user_id', JSON.stringify(updatedUser));
      }
      
      setEditingUser(null);
      showToast(`‚úÖ Role updated to ${newRole}!`);
      loadData();
    } catch (e) {
      showToast('‚ùå Error updating role: ' + e.message);
    }
  }

  async function assignZone(zoneId, userId) {
    if (!ADMIN_IDS.includes(currentUser?.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can assign zones!');
      return;
    }
    
    const member = teamMembers.find(m => m.id === userId);
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current
        .from('zones')
        .update({ assigned_to: userId, color: member?.color || COLORS[0] })
        .eq('id', zoneId);
      
      setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: userId, color: member?.color} : z));
      setSelectedZone(null);
      showToast(`‚úÖ Zone assigned to ${member.name}!`);
    } catch (e) {
      showToast('‚ùå Error assigning zone: ' + e.message);
    }
  }

  async function unassignZone(zoneId) {
    if (!currentUser || currentUser.role !== 'admin') {
      showToast('‚ö†Ô∏è Only admins can unassign zones!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').update({ assigned_to: null }).eq('id', zoneId);
      setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: null} : z));
      setSelectedZone(null);
      showToast('‚úÖ Zone unassigned!');
    } catch (e) {
      showToast('‚ùå Error unassigning zone: ' + e.message);
    }
  }

  async function deleteZone(zoneId) {
    if (!confirm('Delete this zone permanently?')) return;
    
    if (!ADMIN_IDS.includes(currentUser?.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can delete zones!');
      return;
    }
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').delete().eq('id', zoneId);
      setZones(prev => prev.filter(z => z.id !== zoneId));
      setSelectedZone(null);
      showToast('‚úÖ Zone deleted!');
    } catch (e) {
      showToast('‚ùå Error deleting zone: ' + e.message);
    }
  }

  useEffect(() => {
    window.deletePinGlobal = deletePin;
    window.updatePinStatusGlobal = updatePinStatus;
    window.openGHLCalendarGlobal = openGHLCalendar;
    window.showCalendarModal = (data) => {
      setCalendarData(data);
      setShowCalendarModal(true);
    };
    
    return () => {
      delete window.deletePinGlobal;
      delete window.updatePinStatusGlobal;
      delete window.openGHLCalendarGlobal;
      delete window.showCalendarModal;
    };
  }, [currentUser]);

  async function addTeamMember() {
    if (!newUserName.trim()) return;
    
    if (!ADMIN_IDS.includes(currentUser?.id)) {
      showToast('‚ö†Ô∏è Only RDHQ and JOSE can add team members!');
      return;
    }
    
    const newMember = { 
      id: `user-${Date.now()}`, 
      name: newUserName, 
      color: COLORS[teamMembers.length % COLORS.length], 
      role: newUserRole, 
      created_at: new Date().toISOString() 
    };
    
    try {
      await setSupabaseUser(currentUser.id);
      const { data, error } = await supabase.current
        .from('team_members')
        .insert([newMember])
        .select()
        .single();
      
      if (error) throw error;
      
      setTeamMembers(prev => [...prev, data]);
      setNewUserName("");
      setNewUserRole("rep");
      setShowUserModal(false);
      showToast(`‚úÖ ${newUserName} added as ${newUserRole}!`);
    } catch (e) {
      showToast('‚ùå Error adding team member: ' + e.message);
    }
  }

  function selectCurrentUser(user) {
    setCurrentUser(user);
    localStorage.setItem('current_user_id', JSON.stringify(user));
    requestLocationPermission(user);
  }

  function getLeaderboard() {
    const now = new Date();
    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
    startOfWeek.setHours(0, 0, 0, 0);
    const startOfDay = new Date();
    startOfDay.setHours(0, 0, 0, 0);

    return teamMembers.map(member => {
      const memberPins = pins.filter(p => p.team_member_id === member.id);
      const weekPins = memberPins.filter(p => new Date(p.created_at) >= startOfWeek);
      const dayPins = memberPins.filter(p => new Date(p.created_at) >= startOfDay);
      
      let count = 0;
      if (leaderboardType === 'd2d') {
        if (leaderboardPeriod === 'week') {
          count = weekPins.filter(p => ['estimate', 'callback', 'notinterested'].includes(p.status)).length;
        } else if (leaderboardPeriod === 'day') {
          count = dayPins.filter(p => ['estimate', 'callback', 'notinterested'].includes(p.status)).length;
        } else {
          count = memberPins.filter(p => ['estimate', 'callback', 'notinterested'].includes(p.status)).length;
        }
      } else {
        if (leaderboardPeriod === 'week') {
          count = weekPins.filter(p => p.status === 'flyer').length;
        } else if (leaderboardPeriod === 'day') {
          count = dayPins.filter(p => p.status === 'flyer').length;
        } else {
          count = memberPins.filter(p => p.status === 'flyer').length;
        }
      }

      const liveLocation = liveLocations.find(l => l.team_member_id === member.id);
      const isOnline = liveLocation && new Date(liveLocation.last_updated) > new Date(Date.now() - 5 * 60 * 1000);

      return { ...member, knockCount: count, isOnline, liveLocation };
    }).sort((a, b) => b.knockCount - a.knockCount);
  }

  useEffect(() => {
    if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);
    
    if (addressSearch.trim().length < 3) {
      setSearchResults([]);
      return;
    }
    
    setSearching(true);
    searchTimeoutRef.current = setTimeout(async () => {
      const results = await forwardGeocode(addressSearch);
      setSearchResults(results);
      setSearching(false);
    }, 500);
    
    return () => {
      if (searchTimeoutRef.current) clearTimeout(searchTimeoutRef.current);
    };
  }, [addressSearch]);

  async function selectSearchResult(result) {
    if (mapInstanceRef.current) {
      try {
        const details = await getPlaceDetails(result.placeId);
        mapInstanceRef.current.panTo({ lat: details.lat, lng: details.lng });
        mapInstanceRef.current.setZoom(21);
        setAddressSearch("");
        setSearchResults([]);
        showToast('üìç Location found!');
      } catch (error) {
        showToast('‚ùå Error finding location');
      }
    }
  }

  function recenterMap() {
    if (mapInstanceRef.current && currentLocation) {
      mapInstanceRef.current.panTo({ lat: currentLocation.lat, lng: currentLocation.lng });
      mapInstanceRef.current.setZoom(21);
      showToast('üìç Recentered on your location!');
    } else {
      showToast('‚ö†Ô∏è GPS location not available');
    }
  }

  function toggleMapRotation() {
    if (mapInstanceRef.current) {
      const newHeading = (mapHeading + 90) % 360;
      setMapHeading(newHeading);
      mapInstanceRef.current.setHeading(newHeading);
      showToast(`üß≠ Map rotated ${newHeading}¬∞`);
    }
  }

  useEffect(() => {
    if (loading) return;
    
    const map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 47.6062, lng: -122.3321 },
      zoom: 15,
      mapTypeId: 'satellite',
      tilt: 0,
      heading: 0,
      disableDefaultUI: true,
      zoomControl: true,
      zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_BOTTOM },
      gestureHandling: 'greedy',
      minZoom: 10,
      maxZoom: 22
    });

    mapInstanceRef.current = map;

    if (currentLocation) {
      map.setCenter({ lat: currentLocation.lat, lng: currentLocation.lng });
      map.setZoom(21);
    } else if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        map.setCenter({ lat: position.coords.latitude, lng: position.coords.longitude });
        map.setZoom(21);
      });
    }

    map.addListener('click', handleMapClick);
    setMapReady(true);
  }, [loading, isMobile]);

  async function handleMapClick(e) {
    const lat = e.latLng.lat();
    const lng = e.latLng.lng();
    
    if (mode === "drop-pin" && currentUser) {
      if (!currentLocation) {
        showToast('‚ö†Ô∏è Enable GPS tracking first!');
        return;
      }
      
      if (!isGPSFresh(currentLocation)) {
        const age = getGPSAge(currentLocation);
        showToast(`‚ö†Ô∏è GPS data is ${age}s old! Move around to get fresh GPS signal, then try again.`, 6000);
        return;
      }
      
      if (fdMode) {
        const originalStatus = status;
        setStatus('flyer');
        await dropPinAtLocation(lat, lng, '', '', '', '');
        setStatus(originalStatus);
      } else {
        setPendingPinLocation({ lat, lng });
        setShowCustomerForm(true);
      }
    } else if (mode === "draw-zone") {
      if (!ADMIN_IDS.includes(currentUser?.id)) {
        showToast('‚ö†Ô∏è Only RDHQ and JOSE can create zones!');
        return;
      }
      
      addZonePoint(lat, lng);
    }
  }

  function addZonePoint(lat, lng) {
    const newPoints = [...zonePoints, { lat, lng }];
    setZonePoints(newPoints);
    
    if (drawingPolygonRef.current) {
      drawingPolygonRef.current.setMap(null);
    }
    
    if (newPoints.length >= 2) {
      drawingPolygonRef.current = new google.maps.Polygon({
        paths: newPoints,
        map: mapInstanceRef.current,
        fillColor: '#3b82f6',
        fillOpacity: 0.3,
        strokeColor: '#3b82f6',
        strokeWeight: 3
      });
    }
    
    showToast(`üìç Point ${newPoints.length} added`);
  }

  async function finishZone() {
    if (zonePoints.length < 3) {
      showToast('‚ö†Ô∏è Need at least 3 points!');
      return;
    }
    
    const zoneName = prompt('Enter zone name:');
    if (!zoneName) return;
    
    const newZone = {
      id: `zone-${Date.now()}`,
      name: zoneName,
      color: COLORS[zones.length % COLORS.length],
      points: zonePoints,
      created_by: currentUser.name,
      created_at: new Date().toISOString()
    };
    
    try {
      await setSupabaseUser(currentUser.id);
      await supabase.current.from('zones').insert([newZone]);
      setZones(prev => [...prev, newZone]);
      cancelZoneDrawing();
      showToast('‚úÖ Zone created!');
    } catch (e) {
      showToast('‚ùå Error creating zone: ' + e.message);
    }
  }

  function cancelZoneDrawing() {
    setMode("drop-pin");
    setZonePoints([]);
    if (drawingPolygonRef.current) {
      drawingPolygonRef.current.setMap(null);
      drawingPolygonRef.current = null;
    }
  }

  async function dropPinAtLocation(lat, lng, custName, custPhone, custEmail, custNote) {
    setSaving(true);
    setGeocoding(true);

    try {
      const addressData = await reverseGeocode(lat, lng);
      let finalLat = lat, finalLng = lng, address = null, shortAddress = null;
      
      if (addressData && addressData.fullAddress !== 'Address Not Found') {
        finalLat = addressData.lat;
        finalLng = addressData.lng;
        address = addressData.fullAddress;
        shortAddress = addressData.shortAddress;
        showToast(`üìç Found: ${shortAddress}`, 3000);
      } else {
        showToast('‚ö†Ô∏è No address found - saving location anyway', 3000);
      }

      const distance = calculateDistance(currentLocation.lat, currentLocation.lng, finalLat, finalLng);
      const verification = getVerificationStatus(distance);
      
      const clickedZone = zones.find(z => {
        if (!z.points || z.points.length < 3) return false;
        return isPointInPolygon({ lat: finalLat, lng: finalLng }, z.points);
      });

      let finalNote = note || null;
      if (custName) {
        let noteParts = `${custName}${custEmail ? ' - ' + custEmail : ''}${custPhone ? ' - ' + custPhone : ''}`;
        if (custNote || note) noteParts += ' | ' + [custNote, note].filter(Boolean).join(' | ');
        finalNote = noteParts;
      }

      const newPin = { 
        id: `pin-${Date.now()}`, 
        lat: finalLat, 
        lng: finalLng, 
        status: fdMode ? 'flyer' : status, 
        address: address, 
        rep_name: currentUser.name, 
        team_member_id: currentUser.id, 
        zone_id: clickedZone?.id || null, 
        note: finalNote, 
        actual_lat: currentLocation.lat, 
        actual_lng: currentLocation.lng, 
        distance_from_pin: Math.round(distance), 
        verification_status: verification.status, 
        created_at: new Date().toISOString() 
      };
      
      await setSupabaseUser(currentUser.id);
      const { error } = await supabase.current.from('pins').insert([newPin]).select();
      
      if (error) {
        showToast('‚ùå Error saving pin: ' + error.message);
      } else {
        setPins(prev => [newPin, ...prev]);
        setNote("");
        
        const leadTypeLabel = LEAD_TYPES[newPin.status]?.label || newPin.status;
        const gpsAge = getGPSAge(currentLocation);
        const custInfo = custName ? ` for ${custName}` : '';
        
        // Send to GHL if it's an estimate or callback with customer info
        if (custName && (custEmail || custPhone) && ['estimate', 'callback'].includes(newPin.status)) {
          try {
            await sendContactToGHL({ 
              name: custName, 
              email: custEmail, 
              phone: custPhone, 
              address: address, 
              leadType: leadTypeLabel, 
              repName: currentUser.name, 
              verified: verification.status === 'verified', 
              distance: Math.round(distance), 
              createdAt: newPin.created_at 
            });
            showToast('‚úÖ Contact added to GHL!', 3000);
          } catch (ghlError) {
            showToast('‚ö†Ô∏è Pin saved but GHL sync failed', 3000);
          }
        }
        
        if (verification.status === 'verified') {
          showToast(`‚úÖ ${leadTypeLabel}${custInfo} at ${shortAddress || 'location'}! (${Math.round(distance)}ft, GPS: ${gpsAge}s)`, 5000);
        } else if (verification.status === 'suspicious') {
          showToast(`‚ö†Ô∏è ${leadTypeLabel}${custInfo} saved but ${Math.round(distance)}ft away - marked suspicious`, 5000);
        } else {
          showToast(`‚ö†Ô∏è ${leadTypeLabel}${custInfo} saved (${Math.round(distance)}ft - questionable)`, 5000);
        }
      }
    } catch (error) {
      showToast('‚ùå Error: ' + error.message);
    }
    
    setSaving(false);
    setGeocoding(false);
    setShowCustomerForm(false);
    setPendingPinLocation(null);
    setCustomerName('');
    setCustomerPhone('');
    setCustomerEmail('');
    setCustomerNote('');
  }

  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current) return;
    
    markersRef.current.forEach(marker => marker.setMap(null));
    markersRef.current = [];

    const filtered = pins.filter(p => {
      if (filter.status !== "all" && p.status !== filter.status) return false;
      if (filter.userId !== "all" && p.team_member_id !== filter.userId) return false;
      return true;
    });

    filtered.forEach(pin => {
      const user = teamMembers.find(u => u.id === pin.team_member_id);
      const leadType = LEAD_TYPES[pin.status] || LEAD_TYPES.knocked;
      const verification = pin.verification_status ? getVerificationStatus(pin.distance_from_pin || 0) : null;
      
      const marker = new google.maps.Marker({
        position: { lat: pin.lat, lng: pin.lng },
        map: mapInstanceRef.current,
        icon: { 
          path: google.maps.SymbolPath.CIRCLE, 
          scale: 16, 
          fillColor: user?.color || '#64748b', 
          fillOpacity: 1, 
          strokeColor: verification ? verification.color : 'white', 
          strokeWeight: 4 
        },
        label: { 
          text: leadType.display, 
          color: 'white', 
          fontSize: '14px', 
          fontWeight: 'bold' 
        }
      });

      let customerInfo = null, displayNote = pin.note || '';
      if (pin.note && pin.note.includes(' - ') && pin.note.includes('@')) {
        const parts = pin.note.split(' | ');
        const custPart = parts[0];
        displayNote = parts[1] || '';
        const custDetails = custPart.split(' - ');
        if (custDetails.length >= 2) {
          customerInfo = { 
            name: custDetails[0], 
            email: custDetails[1], 
            phone: custDetails[2] || null 
          };
        }
      }
      
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div style="min-width:240px;padding:0;font-family:-apple-system,sans-serif;border-radius:12px;overflow:hidden">
            <div style="background:linear-gradient(135deg, ${leadType.color} 0%, ${leadType.color}dd 100%);padding:16px;color:white">
              <div style="font-size:24px;margin-bottom:4px">${leadType.icon}</div>
              <div style="font-size:18px;font-weight:700">${leadType.label}${customerInfo ? ` - ${customerInfo.name}` : ''}</div>
            </div>
            <div style="padding:16px;background:white">
              ${pin.address ? `<div style="padding:12px;background:#f8fafc;border-left:4px solid #64748b;margin-bottom:12px;border-radius:6px"><div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:6px">üìç ADDRESS</div><div style="font-weight:600;color:#1e293b;font-size:13px;line-height:1.5;margin-bottom:8px">${pin.address}</div>${customerInfo ? `<div style="border-top:1px solid #e2e8f0;padding-top:8px;margin-top:8px">${customerInfo.email ? `<div style="color:#3b82f6;font-size:13px;margin-bottom:4px;display:flex;align-items:center;gap:6px"><span>üìß</span><span>${customerInfo.email}</span></div>` : ''}${customerInfo.phone ? `<div style="color:#3b82f6;font-size:13px;display:flex;align-items:center;gap:6px"><span>üìû</span><span>${customerInfo.phone}</span></div>` : ''}</div>` : ''}</div>` : ''}
              <div style="padding:10px;background:${user?.color || '#64748b'}15;border-left:4px solid ${user?.color || '#64748b'};margin-bottom:12px;border-radius:6px"><div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:4px">üë§ REP</div><div style="font-weight:700;color:${user?.color || '#64748b'};font-size:14px">${pin.rep_name || 'Unknown'}</div></div>
              ${displayNote ? `<div style="padding:10px;background:#f8fafc;border-left:4px solid #64748b;margin-bottom:12px;border-radius:6px"><div style="font-size:12px;color:#64748b;font-weight:600;margin-bottom:4px">üìù NOTE</div><div style="color:#1e293b;font-size:13px">${displayNote}</div></div>` : ''}
              ${verification ? `<div style="padding:12px;background:${verification.color}15;border-left:4px solid ${verification.color};margin-bottom:12px;border-radius:6px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:6px"><span style="font-size:24px">${verification.icon}</span><div><div style="font-weight:700;color:${verification.color};font-size:15px">${verification.label}</div><div style="font-size:13px;color:#64748b;margin-top:2px">Distance: <b>${pin.distance_from_pin} feet</b></div></div></div></div>` : ''}
              <div style="font-size:12px;color:#94a3b8;margin-bottom:14px;text-align:center">${new Date(pin.created_at).toLocaleString()}</div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px">${Object.entries(LEAD_TYPES).slice(0,3).map(([key, type]) => `<button onclick="window.updatePinStatusGlobal('${pin.id}','${key}')" class="modern-button" style="padding:10px 6px;background:${type.color};color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;box-shadow:0 2px 6px ${type.color}40">${type.display}</button>`).join('')}</div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px">${Object.entries(LEAD_TYPES).slice(3).map(([key, type]) => `<button onclick="window.updatePinStatusGlobal('${pin.id}','${key}')" class="modern-button" style="padding:10px 6px;background:${type.color};color:white;border:none;border-radius:8px;font-size:16px;font-weight:700;box-shadow:0 2px 6px ${type.color}40">${type.display}</button>`).join('')}</div>
              ${customerInfo ? `<button onclick="window.openGHLCalendarGlobal('${customerInfo.name}','${customerInfo.email || ''}','${customerInfo.phone || ''}','${pin.address || ''}')" class="modern-button" style="width:100%;padding:12px;background:#10b981;color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;margin-bottom:8px;box-shadow:0 2px 8px rgba(16,185,129,0.3)">üìÖ Book Appointment</button>` : ''}
              <button onclick="window.deletePinGlobal('${pin.id}')" class="modern-button" style="width:100%;padding:12px;background:#ef4444;color:white;border:none;border-radius:10px;font-weight:700;font-size:14px;box-shadow:0 2px 8px rgba(239,68,68,0.3)">üóëÔ∏è Delete Pin</button>
            </div>
          </div>
        `,
        maxWidth: 280
      });
      
      marker.addListener('click', () => {
        markersRef.current.forEach(m => { if (m.infoWindow) m.infoWindow.close(); });
        infoWindow.open(mapInstanceRef.current, marker);
      });
      
      marker.infoWindow = infoWindow;
      markersRef.current.push(marker);
    });
  }, [pins, filter, teamMembers, mapReady]);

  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current) return;
    
    zonePolygonsRef.current.forEach(polygon => polygon.setMap(null));
    zonePolygonsRef.current = [];

    zones.forEach(zone => {
      if (zone.points?.length >= 3) {
        const assigned = teamMembers.find(u => u.id === zone.assigned_to);
        const polygon = new google.maps.Polygon({
          paths: zone.points,
          strokeColor: assigned?.color || zone.color,
          strokeOpacity: 0.8,
          strokeWeight: 3,
          fillColor: assigned?.color || zone.color,
          fillOpacity: 0.2,
          map: mapInstanceRef.current,
          clickable: mode === "select"
        });

        if (mode === "select") {
          const infoWindow = new google.maps.InfoWindow();
          polygon.addListener('click', (e) => {
            infoWindow.setContent(`
              <div style="padding:12px;min-width:180px;font-family:-apple-system,sans-serif">
                <b style="font-size:17px;color:#1e293b">${zone.name}</b><br>
                <div style="margin-top:8px">
                  ${assigned ? `<span style="color:${assigned.color};font-weight:600;font-size:15px">üë§ ${assigned.name}</span>` : '<span style="color:#64748b;font-weight:600">‚ö†Ô∏è Unassigned</span>'}
                </div>
                <div style="margin-top:8px;font-size:13px;color:#64748b">Click to manage zone</div>
              </div>
            `);
            infoWindow.setPosition(e.latLng);
            infoWindow.open(mapInstanceRef.current);
            setSelectedZone(zone);
          });
        }
        
        zonePolygonsRef.current.push(polygon);
      }
    });
  }, [zones, teamMembers, mode, mapReady]);

  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current || !currentLocation || !currentUser) return;
    if (userMarkerRef.current) userMarkerRef.current.setMap(null);

    new google.maps.Circle({ 
      map: mapInstanceRef.current, 
      center: { lat: currentLocation.lat, lng: currentLocation.lng }, 
      radius: currentLocation.accuracy || 50, 
      fillColor: currentUser.color, 
      fillOpacity: 0.15, 
      strokeColor: currentUser.color, 
      strokeOpacity: 0.4, 
      strokeWeight: 2 
    });

    const arrowPath = 'M 0,-24 L 12,24 L 0,18 L -12,24 Z';
    userMarkerRef.current = new google.maps.Marker({ 
      position: { lat: currentLocation.lat, lng: currentLocation.lng }, 
      map: mapInstanceRef.current, 
      icon: { 
        path: arrowPath, 
        fillColor: currentUser.color, 
        fillOpacity: 1, 
        strokeColor: 'white', 
        strokeWeight: 3, 
        scale: 1.5, 
        rotation: currentLocation.heading || 0, 
        anchor: new google.maps.Point(0, 0) 
      }, 
      zIndex: 1000 
    });

    const gpsAge = getGPSAge(currentLocation);
    const isFresh = isGPSFresh(currentLocation);
    const infoWindow = new google.maps.InfoWindow({ 
      content: `
        <div style="padding:14px;text-align:center;font-family:-apple-system,sans-serif">
          <div style="font-weight:700;font-size:18px;color:${currentUser.color};margin-bottom:6px">üìç You Are Here</div>
          <div style="font-size:13px;color:#64748b">GPS: ${gpsAge}s old ${isFresh ? '‚úÖ' : '‚ö†Ô∏è Stale'}</div>
        </div>
      ` 
    });
    
    userMarkerRef.current.addListener('click', () => { 
      infoWindow.open(mapInstanceRef.current, userMarkerRef.current); 
    });
  }, [currentLocation, currentUser, mapReady]);

  useEffect(() => {
    if (!mapReady || !mapInstanceRef.current || !showLiveTracking) return;
    
    liveMarkersRef.current.forEach(marker => marker.setMap(null));
    liveMarkersRef.current = [];

    liveLocations.forEach(loc => {
      const member = teamMembers.find(m => m.id === loc.team_member_id);
      if (!member || loc.team_member_id === currentUser?.id) return;

      const minutesAgo = Math.floor((Date.now() - new Date(loc.last_updated)) / 60000);
      const isRecent = minutesAgo < 5;

      new google.maps.Circle({ 
        map: mapInstanceRef.current, 
        center: { lat: loc.lat, lng: loc.lng }, 
        radius: 35, 
        fillColor: member.color, 
        fillOpacity: isRecent ? 0.4 : 0.2, 
        strokeColor: member.color, 
        strokeWeight: 3 
      });

      const marker = new google.maps.Marker({ 
        position: { lat: loc.lat, lng: loc.lng }, 
        map: mapInstanceRef.current, 
        icon: { 
          path: google.maps.SymbolPath.CIRCLE, 
          scale: 24, 
          fillColor: member.color, 
          fillOpacity: 1, 
          strokeColor: 'white', 
          strokeWeight: 4 
        }, 
        label: { 
          text: member.name.charAt(0), 
          color: 'white', 
          fontSize: '16px', 
          fontWeight: 'bold' 
        } 
      });

      const infoWindow = new google.maps.InfoWindow({ 
        content: `
          <div style="padding:12px;text-align:center;font-family:-apple-system,sans-serif">
            <div style="font-weight:700;font-size:16px;color:${member.color};margin-bottom:4px">${member.name}</div>
            <div style="font-size:13px;color:#64748b">${minutesAgo} min ago</div>
          </div>
        ` 
      });
      
      marker.addListener('click', () => { 
        infoWindow.open(mapInstanceRef.current, marker); 
      });
      
      liveMarkersRef.current.push(marker);
    });
  }, [liveLocations, teamMembers, currentUser, showLiveTracking, mapReady]);

  if (loading) {
    return (
      <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',flexDirection:'column',gap:'1.5rem',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}}>
        <div style={{fontSize:'5rem',animation:'bounce 1s infinite'}}>üè†</div>
        <h1 style={{color:'white',fontSize:'2.5rem',fontWeight:'bold',marginBottom:'0.5rem',textAlign:'center'}}>RepZone V2</h1>
        <p style={{color:'rgba(255,255,255,0.9)',fontSize:'1.125rem',textAlign:'center'}}>Loading Google Maps...</p>
        <div className="spinner" style={{width:'50px',height:'50px',borderWidth:'4px'}}></div>
      </div>
    );
  }

  const stats = {
    totalPins: currentUser ? pins.filter(p => p.team_member_id === currentUser.id).length : 0,
    estimates: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'estimate').length : 0,
    callbacks: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'callback').length : 0,
    notinterested: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'notinterested').length : 0,
    flyers: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'flyer').length : 0,
    knocked: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.status === 'knocked').length : 0,
    verified: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.verification_status === 'verified').length : 0,
    suspicious: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.verification_status === 'suspicious').length : 0,
    onlineUsers: liveLocations.filter(l => new Date(l.last_updated) > new Date(Date.now() - 5 * 60 * 1000)).length,
    withAddress: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && p.address).length : 0,
    withoutAddress: currentUser ? pins.filter(p => p.team_member_id === currentUser.id && !p.address).length : 0
  };

  const leaderboard = getLeaderboard();
  const gpsAge = currentLocation ? getGPSAge(currentLocation) : null;
  const gpsIsFresh = currentLocation ? isGPSFresh(currentLocation) : false;
  const isAdmin = ADMIN_IDS.includes(currentUser?.id);
  
  const filteredLeads = pins.filter(p => {
    if (p.status === 'flyer' || p.status === 'skipped' || p.status === 'knocked') return false;
    return true;
  });

  return (
    <div>
      {toastMessage && <div className="toast">{toastMessage}</div>}

      {mapReady && (
        <>
          <button onClick={recenterMap} className="recenter-btn">üéØ</button>
          <button onClick={toggleMapRotation} className="compass-btn">üß≠</button>
        </>
      )}

      {showCustomerForm && pendingPinLocation && (
        <div className="modal-overlay">
          <div className="modal-content">
            <div className="modal-header">
              <h3 className="modal-title">üìã Customer Info</h3>
              <button 
                onClick={() => { 
                  setShowCustomerForm(false); 
                  setPendingPinLocation(null); 
                  setCustomerName(''); 
                  setCustomerPhone(''); 
                  setCustomerEmail(''); 
                  setCustomerNote(''); 
                }} 
                className="modal-close"
              >√ó</button>
            </div>
            <div style={{marginBottom:'1rem'}}>
              <label className="label-text">Customer Name</label>
              <input 
                value={customerName} 
                onChange={(e) => setCustomerName(e.target.value)} 
                placeholder="Enter customer name..." 
                autoFocus 
                className="input-field"
              />
            </div>
            <div style={{marginBottom:'1rem'}}>
              <label className="label-text">Email <span className="label-optional">(optional)</span></label>
              <input 
                value={customerEmail} 
                onChange={(e) => setCustomerEmail(e.target.value)} 
                placeholder="customer@email.com" 
                type="email" 
                className="input-field"
              />
            </div>
            <div style={{marginBottom:'1.5rem'}}>
              <label className="label-text">Phone Number <span className="label-optional">(optional)</span></label>
              <input 
                value={customerPhone} 
                onChange={(e) => setCustomerPhone(e.target.value)} 
                placeholder="(555) 123-4567" 
                className="input-field"
              />
            </div>
            <div style={{marginBottom:'1.5rem'}}>
              <label className="label-text">Note <span className="label-optional">(optional)</span></label>
              <textarea 
                value={customerNote} 
                onChange={(e) => setCustomerNote(e.target.value)} 
                placeholder="Gate code, dog in yard, callback time..." 
                rows={2} 
                className="textarea-field"
              />
            </div>
            <button 
              onClick={async () => { 
                await dropPinAtLocation(
                  pendingPinLocation.lat, 
                  pendingPinLocation.lng, 
                  customerName, 
                  customerPhone, 
                  customerEmail, 
                  customerNote
                ); 
              }} 
              className="btn-primary"
            >üìç Drop Pin</button>
          </div>
        </div>
      )}

      {(saving || geocoding) && (
        <div className="loading-overlay">
          <div className="spinner" style={{width:'40px',height:'40px',borderWidth:'4px',borderTopColor:'#3b82f6'}}></div>
          <span className="loading-text">{geocoding ? 'üè† Finding Address...' : 'üíæ Saving...'}</span>
        </div>
      )}

      {trackingEnabled && !isMobile && (
        <div style={{
          position:'fixed',
          top:'1rem',
          right:'1rem',
          background:gpsIsFresh?'#10b981':'#f59e0b',
          color:'white',
          padding:'0.875rem 1.5rem',
          borderRadius:'2rem',
          boxShadow:'0 6px 16px rgba(0,0,0,0.2)',
          zIndex:10001,
          display:'flex',
          gap:'0.875rem',
          alignItems:'center',
          fontSize:'0.9375rem',
          fontWeight:'700'
        }}>
          <div style={{width:'14px',height:'14px',background:'white',borderRadius:'50%',animation:'pulse 2s infinite'}}></div>
          <span>GPS {gpsAge !== null ? `${gpsAge}s` : 'Active'} {gpsIsFresh ? '‚úÖ' : '‚ö†Ô∏è'}</span>
        </div>
      )}

      {!currentUser && (
        <div className="modal-overlay">
          <div className="modal-content" style={{maxHeight:'80vh',overflowY:'auto'}}>
            <h2 style={{fontSize:'1.75rem',fontWeight:'bold',marginBottom:'0.75rem',color:'#1e293b'}}>üëã Select Your Profile</h2>
            <p style={{color:'#64748b',marginBottom:'1.5rem',fontSize:'0.9375rem',fontWeight:'600'}}>Choose your name to start tracking</p>
            <div style={{marginBottom:'1rem'}}>
              {teamMembers.map(member => (
                <div key={member.id} className="user-card">
                  <div onClick={() => selectCurrentUser(member)} style={{flex:1,display:'flex',alignItems:'center',gap:'1rem'}}>
                    <div style={{
                      width:'56px',
                      height:'56px',
                      borderRadius:'50%',
                      background:member.color,
                      display:'flex',
                      alignItems:'center',
                      justifyContent:'center',
                      color:'white',
                      fontWeight:'bold',
                      fontSize:'1.5rem',
                      flexShrink:0,
                      boxShadow:'0 4px 12px rgba(0,0,0,0.15)'
                    }}>
                      {member.name.charAt(0)}
                    </div>
                    <div>
                      <div style={{fontWeight:'700',fontSize:'1.125rem',color:'#1e293b'}}>{member.name}</div>
                      <div style={{fontSize:'0.8125rem',color:'#64748b',fontWeight:'600'}}>{member.role}</div>
                    </div>
                  </div>
                  {isAdmin && (
                    <div className="user-menu">
                      <button 
                        className="user-menu-btn" 
                        onClick={(e) => { 
                          e.stopPropagation(); 
                          setEditingUser(editingUser?.id === member.id ? null : member); 
                        }}
                      >‚ãÆ</button>
                      {editingUser?.id === member.id && (
                        <div className="dropdown-menu" onClick={(e) => e.stopPropagation()}>
                          <div 
                            className="dropdown-item" 
                            onClick={() => updateUserRole(member.id, member.role === 'admin' ? 'rep' : 'admin')}
                          >
                            {member.role === 'admin' ? 'üë§ Make Rep' : '‚≠ê Make Admin'}
                          </div>
                          <div 
                            className="dropdown-item" 
                            style={{color:'#ef4444'}} 
                            onClick={() => deleteUser(member.id)}
                          >üóëÔ∏è Delete</div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              ))}
            </div>
            {isAdmin && (
              <button 
                onClick={() => setShowUserModal(true)} 
                className="btn-primary"
              >‚ûï Add New Member</button>
            )}
          </div>
        </div>
      )}

      {showUserModal && (
        <div className="modal-overlay">
          <div className="modal-content">
            <h3 style={{fontSize:'1.5rem',fontWeight:'bold',marginBottom:'1.5rem',color:'#1e293b'}}>‚ûï Add Team Member</h3>
            <input 
              value={newUserName} 
              onChange={e => setNewUserName(e.target.value)} 
              placeholder="Full Name" 
              className="input-field"
              style={{marginBottom:'1rem'}}
              onKeyPress={e => e.key === 'Enter' && addTeamMember()}
            />
            <select 
              value={newUserRole} 
              onChange={e => setNewUserRole(e.target.value)} 
              className="input-field"
              style={{marginBottom:'1.5rem'}}
            >
              <option value="rep">üë§ Rep</option>
              <option value="flyer">üì¨ Flyer Marketer</option>
              <option value="admin">‚≠ê Admin</option>
            </select>
            <div style={{display:'flex',gap:'0.75rem'}}>
              <button 
                onClick={addTeamMember} 
                className="btn-primary" 
                style={{flex:1}}
              >Add Member</button>
              <button 
                onClick={() => {
                  setShowUserModal(false); 
                  setNewUserName(""); 
                  setNewUserRole("rep");
                }} 
                className="btn-secondary"
                style={{flex:1}}
              >Cancel</button>
            </div>
          </div>
        </div>
      )}

      {showCalendarModal && calendarData && (
        <div className="modal-overlay" onClick={() => setShowCalendarModal(false)}>
          <div className="modal-content" style={{maxWidth:'700px'}} onClick={(e) => e.stopPropagation()}>
            <h2 style={{fontSize:'1.5rem',fontWeight:'700',color:'#1e293b',marginBottom:'1rem'}}>üìÖ Book Estimate</h2>
            <iframe
              src={GHL_CONFIG.calendarUrls.general}
              style={{width:'100%',height:'600px',border:'none',borderRadius:'1rem'}}
            />
            <button
              onClick={() => setShowCalendarModal(false)}
              className="btn-secondary"
              style={{width:'100%',marginTop:'1rem'}}
            >Close</button>
          </div>
        </div>
  )}

  <button 
    className="hamburger-btn" 
    onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
  >
    <span></span>
    <span></span>
    <span></span>
  </button>

  <div 
    className={`${isMobile ? 'mobile-dropdown' : 'desktop-sidebar'} ${mobileMenuOpen ? 'open' : ''}`} 
    style={{
      flexDirection:'column',
      background:'white',
      borderRadius:isMobile?0:'1.5rem',
      boxShadow:'0 8px 32px rgba(0,0,0,0.15)',
      overflow:'hidden'
    }}
  >
    <div style={{padding:'1.5rem',borderBottom:'1px solid #e5e7eb'}}>
      <h1 style={{fontSize:'1.875rem',fontWeight:'700',color:'#1e293b',marginBottom:'0.25rem'}}>üè† RepZone V2</h1>
      <p style={{fontSize:'0.875rem',color:'#64748b'}}>Door Knocking Tracker</p>
      
      {currentUser && (
        <div style={{display:'flex',alignItems:'center',gap:'0.75rem',marginTop:'1rem',padding:'1rem',background:'#f8fafc',borderRadius:'1rem'}}>
          <div style={{
            width:'48px',
            height:'48px',
            borderRadius:'50%',
            background:currentUser.color,
            display:'flex',
            alignItems:'center',
            justifyContent:'center',
            color:'white',
            fontWeight:'700',
            fontSize:'1.25rem'
          }}>
            {currentUser.name.charAt(0)}
          </div>
          <div style={{flex:1}}>
            <div style={{fontWeight:'600',color:'#1e293b'}}>{currentUser.name}</div>
            <div style={{fontSize:'0.75rem',color:'#64748b',textTransform:'uppercase'}}>{currentUser.role}</div>
          </div>
          <button 
            onClick={() => {
              if (confirm('Switch user?')) {
                setCurrentUser(null);
                localStorage.removeItem('current_user_id');
              }
            }} 
            style={{
              padding:'0.5rem 1rem',
              background:'#e5e7eb',
              border:'none',
              borderRadius:'0.5rem',
              fontSize:'0.875rem',
              fontWeight:'600',
              cursor:'pointer'
            }}
          >Switch</button>
        </div>
      )}
    </div>

    <div style={{display:'flex',borderBottom:'1px solid #e5e7eb'}}>
      <div 
        className={`tab ${activeTab==='map'?'active':''}`} 
        onClick={()=>setActiveTab('map')} 
        style={{flex:1,textAlign:'center'}}
      >üó∫Ô∏è Map</div>
      <div 
        className={`tab ${activeTab==='stats'?'active':''}`} 
        onClick={()=>setActiveTab('stats')} 
        style={{flex:1,textAlign:'center'}}
      >üìä Stats</div>
      <div 
        className={`tab ${activeTab==='leaderboard'?'active':''}`} 
        onClick={()=>setActiveTab('leaderboard')} 
        style={{flex:1,textAlign:'center'}}
      >üèÜ Leaders</div>
      <div 
        className={`tab ${activeTab==='crm'?'active':''}`} 
        onClick={()=>setActiveTab('crm')} 
        style={{flex:1,textAlign:'center'}}
      >üìã CRM</div>
    </div>

    <div style={{flex:1,overflowY:'auto',padding:'1.5rem'}}>
      {activeTab === 'map' && (
        <>
          <div className="stat-card" style={{marginBottom:'1rem'}}>
            <h3 style={{fontSize:'1rem',fontWeight:'600',marginBottom:'1rem',color:'#1e293b'}}>üéØ Mode</h3>
            <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'0.5rem',marginBottom:'1rem'}}>
              <div 
                className={`mode-btn ${mode==='drop-pin'?'active':''}`} 
                onClick={() => handleModeChange('drop-pin')}
              >üìç Pin</div>
              <div 
                className={`mode-btn ${mode==='draw-zone'?'active':''}`} 
                onClick={() => handleModeChange('draw-zone')}
              >‚úèÔ∏è Zone</div>
              <div 
                className={`mode-btn ${mode==='select'?'active':''}`} 
                onClick={() => handleModeChange('select')}
              >üëÜ Select</div>
            </div>
            
            {mode === 'draw-zone' && zonePoints.length > 0 && (
              <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem'}}>
                <button 
                  onClick={finishZone} 
                  className="modern-button" 
                  style={{
                    flex:1,
                    padding:'0.75rem',
                    background:'#10b981',
                    color:'white',
                    border:'none',
                    borderRadius:'0.5rem',
                    fontWeight:'700'
                  }}
                >‚úÖ Finish ({zonePoints.length})</button>
                <button 
                  onClick={cancelZoneDrawing} 
                  className="modern-button" 
                  style={{
                    padding:'0.75rem',
                    background:'#ef4444',
                    color:'white',
                    border:'none',
                    borderRadius:'0.5rem',
                    fontWeight:'700'
                  }}
                >‚úñ</button>
              </div>
            )}
            
            {mode === 'drop-pin' && (
              <div style={{
                padding:'0.75rem',
                background:'#d1fae5',
                borderRadius:'0.5rem',
                fontSize:'0.875rem',
                fontWeight:'600',
                color:'#065f46',
                textAlign:'center'
              }}>
                ‚úÖ Click map - gets full address!
              </div>
            )}
          </div>

          <div className="stat-card" style={{marginBottom:'1rem'}}>
            <h3 style={{fontSize:'1rem',fontWeight:'600',marginBottom:'1rem',color:'#1e293b'}}>üéØ Lead Type</h3>
            <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem',marginBottom:'1rem'}}>
              {Object.entries(LEAD_TYPES).slice(0,4).map(([key, type]) => (
                <div 
                  key={key} 
                  onClick={() => setStatus(key)} 
                  className={`lead-type-btn ${status===key?'active':''}`}
                  style={{
                    background:type.color,
                    color:'white'
                  }}
                >
                  <div style={{fontSize:'1.5rem',marginBottom:'0.25rem'}}>{type.icon}</div>
                  <div style={{fontSize:'0.875rem',fontWeight:'700'}}>{type.label}</div>
                </div>
              ))}
            </div>
            
            <button 
              onClick={() => setFdMode(!fdMode)} 
              className="modern-button" 
              style={{
                width:'100%',
                padding:'0.875rem',
                background:fdMode?'#10b981':'#3b82f6',
                color:'white',
                border:'none',
                borderRadius:'0.75rem',
                fontWeight:'700',
                marginBottom:'0.75rem'
              }}
            >{fdMode ? '‚úÖ FD Mode ON' : 'üèòÔ∏è Enable FD Mode'}</button>
            
            <textarea 
              value={note} 
              onChange={(e) => setNote(e.target.value)} 
              placeholder="Note (gate code, dog, etc.)" 
              rows={2} 
              className="textarea-field"
            />
          </div>

          <div className="stat-card" style={{marginBottom:'1rem'}}>
            <h3 style={{fontSize:'1rem',fontWeight:'600',marginBottom:'1rem',color:'#1e293b'}}>üîç Search Address</h3>
            <input 
              value={addressSearch} 
              onChange={(e) => setAddressSearch(e.target.value)} 
              placeholder="Type address to find location..." 
              className="search-input"
            />
            {searching && (
              <div style={{marginTop:'0.5rem',fontSize:'0.875rem',color:'#64748b',fontWeight:'600'}}>
                Searching...
              </div>
            )}
            {searchResults.length > 0 && (
              <div style={{marginTop:'0.5rem',maxHeight:'200px',overflowY:'auto'}}>
                {searchResults.map((result, idx) => (
                  <div 
                    key={idx} 
                    onClick={() => selectSearchResult(result)} 
                    className="search-result"
                  >{result.displayName}</div>
                ))}
              </div>
            )}
          </div>

          {trackingEnabled && currentLocation && (
            <div className={`gps-indicator ${!gpsIsFresh?'stale':''}`}>
              <div className="gps-indicator-content">
                <div className={`gps-dot ${!gpsIsFresh?'stale':''} tracking-indicator`}></div>
                <div>
                  <div className="gps-status">GPS {gpsIsFresh ? 'Active' : 'Stale'}</div>
                  <div className="gps-details">
                    Age: {gpsAge}s ‚Ä¢ Accuracy: ¬±{currentLocation.accuracy?.toFixed(0)}ft
                  </div>
                </div>
              </div>
            </div>
          )}

          {zones.length > 0 && (
            <div style={{
              marginTop:'1rem',
              padding:'1rem',
              background:'#eff6ff',
              borderRadius:'1rem',
              border:'2px solid #3b82f6'
            }}>
              <div style={{
                fontWeight:'700',
                marginBottom:'0.5rem',
                display:'flex',
                alignItems:'center',
                justifyContent:'space-between',
                color:'#1e293b'
              }}>
                <span>üó∫Ô∏è Zones ({zones.length})</span>
              </div>
              {zones.map(zone => (
                <div 
                  key={zone.id} 
                  style={{
                    padding:'0.5rem',
                    background:'white',
                    borderRadius:'0.5rem',
                    marginBottom:'0.5rem',
                    fontSize:'0.875rem',
                    display:'flex',
                    alignItems:'center',
                    justifyContent:'space-between'
                  }}
                >
                  <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                    <span style={{
                      display:'inline-block',
                      width:'10px',
                      height:'10px',
                      borderRadius:'50%',
                      background:zone.color
                    }}></span>
                    {zone.name}
                  </div>
                  {isAdmin && (
                    <button 
                      onClick={() => deleteZone(zone.id)} 
                      style={{
                        padding:'0.25rem 0.5rem',
                        background:'#ef4444',
                        color:'white',
                        border:'none',
                        borderRadius:'0.375rem',
                        fontSize:'0.75rem',
                        fontWeight:'600',
                        cursor:'pointer'
                      }}
                    >Delete</button>
                  )}
                </div>
              ))}
            </div>
          )}
        </>
      )}

      {activeTab === 'stats' && (
        <div className="stat-card">
          <h3 style={{fontSize:'1rem',fontWeight:'600',marginBottom:'1rem',color:'#1e293b'}}>üìä Your Stats</h3>
          <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:'0.75rem'}}>
            <div style={{padding:'1rem',background:'#f8fafc',borderRadius:'0.75rem',textAlign:'center',border:'2px solid #e5e7eb'}}>
              <div style={{fontSize:'2rem',fontWeight:'700',color:'#10b981'}}>{stats.estimates}</div>
              <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',textTransform:'uppercase'}}>ESTIMATES</div>
            </div>
            <div style={{padding:'1rem',background:'#f8fafc',borderRadius:'0.75rem',textAlign:'center',border:'2px solid #e5e7eb'}}>
              <div style={{fontSize:'2rem',fontWeight:'700',color:'#f59e0b'}}>{stats.callbacks}</div>
              <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',textTransform:'uppercase'}}>CALLBACKS</div>
            </div>
            <div style={{padding:'1rem',background:'#f8fafc',borderRadius:'0.75rem',textAlign:'center',border:'2px solid #e5e7eb'}}>
              <div style={{fontSize:'2rem',fontWeight:'700',color:'#3b82f6'}}>{stats.flyers}</div>
              <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',textTransform:'uppercase'}}>FLYERS</div>
            </div>
            <div style={{padding:'1rem',background:'#f8fafc',borderRadius:'0.75rem',textAlign:'center',border:'2px solid #e5e7eb'}}>
              <div style={{fontSize:'2rem',fontWeight:'700',color:'#1e293b'}}>{stats.totalPins}</div>
              <div style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'600',textTransform:'uppercase'}}>TOTAL</div>
            </div>
          </div>
        </div>
      )}

      {activeTab === 'leaderboard' && (
        <div className="stat-card">
          <h3 style={{fontSize:'1rem',fontWeight:'600',marginBottom:'1rem',color:'#1e293b'}}>üèÜ Leaderboard</h3>
          
          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem'}}>
            {['day', 'week', 'all'].map(period => (
              <button 
                key={period} 
                onClick={() => setLeaderboardPeriod(period)} 
                className={`filter-btn ${leaderboardPeriod===period?'active':''}`}
                style={{flex:1}}
              >
                {period==='day'?'Today':period==='week'?'Week':'All Time'}
              </button>
            ))}
          </div>
          
          <div style={{display:'flex',gap:'0.5rem',marginBottom:'1rem'}}>
            {['d2d', 'flyer'].map(type => (
              <button 
                key={type} 
                onClick={() => setLeaderboardType(type)} 
                className={`filter-btn ${leaderboardType===type?'active':''}`}
                style={{flex:1}}
              >
                {type==='d2d'?'üö™ Door-to-Door':'üì¨ Flyer Drops'}
              </button>
            ))}
          </div>
          
          <div style={{maxHeight:'400px',overflowY:'auto'}}>
            {leaderboard.map((member, idx) => (
              <div 
                key={member.id} 
                style={{
                  display:'flex',
                  alignItems:'center',
                  gap:'0.75rem',
                  padding:'0.875rem',
                  background:'white',
                  borderRadius:'0.75rem',
                  marginBottom:'0.5rem',
                  border:'2px solid #e5e7eb'
                }}
              >
                <div 
                  className={`rank-badge ${idx<3?`rank-${idx+1}`:''}`}
                  style={idx>=3?{background:'#334155',color:'white'}:{}}
                >{idx+1}</div>
                <div style={{
                  width:'32px',
                  height:'32px',
                  borderRadius:'50%',
                  background:member.color,
                  display:'flex',
                  alignItems:'center',
                  justifyContent:'center',
                  color:'white',
                  fontWeight:'700',
                  fontSize:'0.875rem'
                }}>{member.name.charAt(0)}</div>
                <div style={{flex:1}}>
                  <div style={{fontWeight:'600',color:'#1e293b',fontSize:'0.9375rem'}}>{member.name}</div>
                  <div style={{fontSize:'0.75rem',color:'#64748b'}}>
                    {member.isOnline ? 'üü¢ Online' : '‚ö™ Offline'}
                  </div>
                </div>
                <div style={{textAlign:'right'}}>
                  <div style={{fontSize:'1.25rem',fontWeight:'700',color:'#1e293b'}}>{member.knockCount}</div>
                  <div style={{fontSize:'0.625rem',color:'#64748b',fontWeight:'600',textTransform:'uppercase'}}>KNOCKS</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {activeTab === 'crm' && (
        <div className="stat-card">
          <h3 style={{fontSize:'1rem',fontWeight:'600',marginBottom:'1rem',color:'#1e293b'}}>
            üìã Leads ({filteredLeads.length})
          </h3>
          
          <div style={{maxHeight:'500px',overflowY:'auto'}}>
            {filteredLeads.length === 0 ? (
              <div style={{textAlign:'center',padding:'2rem',color:'#64748b'}}>No leads yet</div>
            ) : (
              filteredLeads.map(pin => {
                const leadType = LEAD_TYPES[pin.status];
                let customerInfo = null;
                
                if (pin.note && pin.note.includes(' - ') && pin.note.includes('@')) {
                  const custPart = pin.note.split(' | ')[0];
                  const custDetails = custPart.split(' - ');
                  if (custDetails.length >= 2) {
                    customerInfo = { 
                      name: custDetails[0], 
                      email: custDetails[1], 
                      phone: custDetails[2] || null 
                    };
                  }
                }
                
                return (
                  <div 
                    key={pin.id} 
                    style={{
                      padding:'1rem',
                      background:'white',
                      borderRadius:'0.75rem',
                      marginBottom:'0.5rem',
                      border:'2px solid #e5e7eb'
                    }}
                  >
                    <div style={{
                      display:'flex',
                      alignItems:'center',
                      gap:'0.5rem',
                      marginBottom:'0.5rem'
                    }}>
                      <span style={{fontSize:'1.25rem'}}>{leadType?.icon}</span>
                      <span style={{
                        fontWeight:'600',
                        color:leadType?.color,
                        fontSize:'0.9375rem'
                      }}>{leadType?.label}</span>
                    </div>
                    
                    {customerInfo && (
                      <div style={{marginBottom:'0.5rem'}}>
                        <div style={{fontWeight:'700',color:'#1e293b'}}>{customerInfo.name}</div>
                        {customerInfo.email && (
                          <div style={{fontSize:'0.875rem',color:'#3b82f6'}}>{customerInfo.email}</div>
                        )}
                        {customerInfo.phone && (
                          <div style={{fontSize:'0.875rem',color:'#3b82f6'}}>{customerInfo.phone}</div>
                        )}
                      </div>
                    )}
                    
                    <div style={{fontSize:'0.875rem',color:'#64748b',marginBottom:'0.25rem'}}>
                      {pin.address || 'No address'}
                    </div>
                    <div style={{fontSize:'0.75rem',color:'#94a3b8'}}>
                      {new Date(pin.created_at).toLocaleString()}
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      )}
    </div>
  </div>
</div>
);
}
ReactDOM.createRoot(document.getElementById('root')).render(<RepZoneApp />);
</script>
</body>
</html>
