<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RepZone V2</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, sans-serif; }
  
  #map-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
  #map { width: 100%; height: 100%; }
  
  .sidebar { position: fixed; top: 1rem; left: 1rem; width: 400px; max-height: calc(100vh - 2rem); background: white; border-radius: 1rem; box-shadow: 0 8px 32px rgba(0,0,0,0.15); z-index: 1000; display: flex; flex-direction: column; overflow: hidden; }
  .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; }
  .sidebar-content { flex: 1; overflow-y: auto; padding: 1.5rem; }
  
  .btn { padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
  .btn-primary { background: #3b82f6; color: white; }
  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
  .btn-secondary { background: #e5e7eb; color: #1e293b; }
  
  .zone-overlay { stroke-width: 3px; fill-opacity: 0.35; stroke-opacity: 0.9; cursor: pointer; }
  
  .toast { position: fixed; top: 5rem; right: 1rem; background: white; padding: 1rem 1.5rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 10001; animation: slideIn 0.3s; }
  @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  
  .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10003; padding: 1rem; }
  .modal-content { background: white; border-radius: 1.5rem; padding: 2rem; max-width: 440px; width: 100%; max-height: 90vh; overflow-y: auto; }
  
  .zone-item { padding: 1rem; background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; }
  .zone-item:hover { border-color: #3b82f6; transform: translateX(4px); }
  
  .recenter-btn { position: fixed; bottom: 180px; right: 20px; width: 56px; height: 56px; background: white; border: 2px solid #3b82f6; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
</style>
</head>
<body>
<div id="map-container"><div id="map"></div></div>
<div id="root"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxqGzPnCxZNpH3Xopsk4VnwZOxVLjSQWc&libraries=places,geometry"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ==================== CONFIG ====================
const SUPABASE_URL = 'https://cytikhfyygkovnjtpsth.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dGlraGZ5eWdrb3ZuanRwc3RoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTc3NzYsImV4cCI6MjA3NjI5Mzc3Nn0.ItJObIXo_Ks8TEigj5RkUA4vXbze_3FMMIzYyVHrthQ';
const ADMIN_IDS = ['user-1760858671762', 'user-1760855853315'];

const USERS = [
  { id: 'user-1760858671762', name: 'RDHQ', role: 'admin', color: '#3b82f6' },
  { id: 'user-1760855853315', name: 'JOSE', role: 'admin', color: '#10b981' },
  { id: 'user-ben', name: 'BEN', role: 'rep', color: '#3b82f6' },
  { id: 'user-hector', name: 'HECTOR', role: 'rep', color: '#ec4899' },
  { id: 'user-christine', name: 'Christine', role: 'flyer', color: '#78350f' }
];

// ==================== APP ====================
function App() {
  const [zones, setZones] = useState([]);
  const [currentUser, setCurrentUser] = useState(null);
  const [mode, setMode] = useState('view');
  const [zonePoints, setZonePoints] = useState([]);
  const [selectedZone, setSelectedZone] = useState(null);
  const [showAssignModal, setShowAssignModal] = useState(false);
  const [toast, setToast] = useState(null);
  const [loading, setLoading] = useState(true);

  const mapRef = useRef(null);
  const supabase = useRef(null);
  const polygonsRef = useRef([]);
  const drawingPolygonRef = useRef(null);

  useEffect(() => {
    supabase.current = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    loadZones();
    initMap();
    
    const saved = localStorage.getItem('rz_user');
    if (saved) {
      const user = USERS.find(u => u.id === saved);
      if (user) setCurrentUser(user);
    }
  }, []);

  async function loadZones() {
    try {
      const { data } = await supabase.current.from('zones').select('*').order('created_at', { ascending: false });
      setZones(data || []);
    } catch (e) {
      console.error('Load error:', e);
    }
    setLoading(false);
  }

  function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 47.6062, lng: -122.3321 },
      zoom: 12,
      mapTypeId: 'satellite',
      disableDefaultUI: true,
      zoomControl: true,
      gestureHandling: 'greedy'
    });
    mapRef.current = map;
    map.addListener('click', handleMapClick);
  }

  function handleMapClick(e) {
    if (mode === 'draw') {
      addZonePoint(e.latLng.lat(), e.latLng.lng());
    }
  }

  function addZonePoint(lat, lng) {
    const newPoints = [...zonePoints, { lat, lng }];
    setZonePoints(newPoints);
    
    if (drawingPolygonRef.current) drawingPolygonRef.current.setMap(null);
    
    if (newPoints.length >= 2) {
      drawingPolygonRef.current = new google.maps.Polygon({
        paths: newPoints,
        map: mapRef.current,
        fillColor: '#3b82f6',
        fillOpacity: 0.35,
        strokeColor: '#3b82f6',
        strokeWeight: 3
      });
    }
    
    showToast(`Point ${newPoints.length} added`);
  }

  async function finishZone() {
    if (zonePoints.length < 3) {
      showToast('Need at least 3 points!');
      return;
    }
    
    const name = prompt('Zone name:');
    if (!name) return;
    
    const zone = {
      id: `zone-${Date.now()}`,
      name,
      color: '#3b82f6',
      points: zonePoints,
      created_by: currentUser.name,
      assigned_to: null,
      created_at: new Date().toISOString()
    };
    
    try {
      await supabase.current.from('zones').insert([zone]);
      setZones(prev => [zone, ...prev]);
      cancelDrawing();
      showToast('‚úÖ Zone created!');
    } catch (e) {
      showToast('‚ùå Error: ' + e.message);
    }
  }

  function cancelDrawing() {
    setMode('view');
    setZonePoints([]);
    if (drawingPolygonRef.current) {
      drawingPolygonRef.current.setMap(null);
      drawingPolygonRef.current = null;
    }
  }

  async function assignZone(zoneId, userId) {
    const user = USERS.find(u => u.id === userId);
    try {
      await supabase.current.from('zones').update({ assigned_to: userId, color: user.color }).eq('id', zoneId);
      setZones(prev => prev.map(z => z.id === zoneId ? {...z, assigned_to: userId, color: user.color} : z));
      setShowAssignModal(false);
      setSelectedZone(null);
      showToast(`‚úÖ Assigned to ${user.name}`);
    } catch (e) {
      showToast('‚ùå Error: ' + e.message);
    }
  }

  async function deleteZone(zoneId) {
    if (!confirm('Delete zone?')) return;
    try {
      await supabase.current.from('zones').delete().eq('id', zoneId);
      setZones(prev => prev.filter(z => z.id !== zoneId));
      setSelectedZone(null);
      showToast('‚úÖ Deleted');
    } catch (e) {
      showToast('‚ùå Error: ' + e.message);
    }
  }

  useEffect(() => {
    if (!mapRef.current) return;
    
    polygonsRef.current.forEach(p => p.setMap(null));
    polygonsRef.current = [];
    
    zones.forEach(zone => {
      if (zone.points?.length >= 3) {
        const polygon = new google.maps.Polygon({
          paths: zone.points,
          fillColor: zone.color || '#3b82f6',
          fillOpacity: 0.35,
          strokeColor: zone.color || '#3b82f6',
          strokeWeight: 3,
          strokeOpacity: 0.9,
          map: mapRef.current,
          clickable: true
        });
        
        polygon.addListener('click', () => {
          if (mode === 'view' && isAdmin) {
            setSelectedZone(zone);
            setShowAssignModal(true);
          }
        });
        
        polygonsRef.current.push(polygon);
      }
    });
  }, [zones, mode]);

  function showToast(msg, duration = 3000) {
    setToast(msg);
    setTimeout(() => setToast(null), duration);
  }

  function selectUser(user) {
    setCurrentUser(user);
    localStorage.setItem('rz_user', user.id);
  }

  function recenter() {
    if (mapRef.current) {
      mapRef.current.panTo({ lat: 47.6062, lng: -122.3321 });
      mapRef.current.setZoom(12);
    }
  }

  const isAdmin = ADMIN_IDS.includes(currentUser?.id);
  const visibleZones = isAdmin ? zones : zones.filter(z => z.assigned_to === currentUser?.id);

  if (loading) {
    return (
      <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}}>
        <h1 style={{color:'white',fontSize:'3rem',fontWeight:'bold'}}>RepZone V2</h1>
      </div>
    );
  }

  return (
    <div>
      {toast && <div className="toast">{toast}</div>}
      
      <button onClick={recenter} className="recenter-btn">üéØ</button>

      {!currentUser && (
        <div className="modal">
          <div className="modal-content">
            <h2 style={{fontSize:'1.75rem',fontWeight:'bold',marginBottom:'1.5rem'}}>Select User</h2>
            {USERS.map(user => (
              <div key={user.id} onClick={() => selectUser(user)} style={{padding:'1rem',background:'#f8fafc',borderRadius:'0.75rem',marginBottom:'0.75rem',cursor:'pointer',display:'flex',alignItems:'center',gap:'1rem'}}>
                <div style={{width:'48px',height:'48px',borderRadius:'50%',background:user.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.25rem'}}>{user.name.charAt(0)}</div>
                <div>
                  <div style={{fontWeight:'700',fontSize:'1.125rem'}}>{user.name}</div>
                  <div style={{fontSize:'0.875rem',color:'#64748b'}}>{user.role}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {showAssignModal && selectedZone && (
        <div className="modal">
          <div className="modal-content">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.5rem'}}>
              <h3 style={{fontSize:'1.5rem',fontWeight:'bold'}}>üó∫Ô∏è {selectedZone.name}</h3>
              <button onClick={() => setShowAssignModal(false)} style={{width:'40px',height:'40px',borderRadius:'50%',border:'none',background:'#f1f5f9',fontSize:'1.5rem',cursor:'pointer'}}>√ó</button>
            </div>
            
            <div style={{padding:'1rem',background:'#f8fafc',borderRadius:'0.75rem',marginBottom:'1.5rem'}}>
              <div style={{fontSize:'0.75rem',color:'#64748b',marginBottom:'0.5rem'}}>CREATED</div>
              <div style={{fontWeight:'700'}}>{new Date(selectedZone.created_at).toLocaleDateString()}</div>
              <div style={{fontSize:'0.875rem',color:'#64748b'}}>By {selectedZone.created_by}</div>
            </div>

            {selectedZone.assigned_to ? (
              <div style={{padding:'1rem',background:'#d1fae5',borderRadius:'0.75rem',border:'2px solid #10b981',marginBottom:'1rem'}}>
                <div style={{fontSize:'0.75rem',color:'#065f46',marginBottom:'0.5rem'}}>‚úÖ ASSIGNED TO</div>
                <div style={{fontWeight:'700',fontSize:'1.125rem',color:'#065f46'}}>{USERS.find(u => u.id === selectedZone.assigned_to)?.name}</div>
              </div>
            ) : (
              <div>
                <p style={{fontSize:'0.9375rem',color:'#64748b',marginBottom:'1rem'}}>Assign to:</p>
                {USERS.map(user => (
                  <div key={user.id} onClick={() => assignZone(selectedZone.id, user.id)} style={{padding:'1rem',background:'white',border:'2px solid #e5e7eb',borderRadius:'0.75rem',marginBottom:'0.75rem',cursor:'pointer',display:'flex',alignItems:'center',gap:'1rem'}}>
                    <div style={{width:'48px',height:'48px',borderRadius:'50%',background:user.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold',fontSize:'1.25rem'}}>{user.name.charAt(0)}</div>
                    <div>
                      <div style={{fontWeight:'700'}}>{user.name}</div>
                      <div style={{fontSize:'0.875rem',color:'#64748b'}}>{user.role}</div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            <button onClick={() => deleteZone(selectedZone.id)} className="btn btn-secondary" style={{width:'100%',marginTop:'1rem',background:'#ef4444',color:'white'}}>üóëÔ∏è Delete</button>
          </div>
        </div>
      )}

      {currentUser && (
        <div className="sidebar">
          <div className="sidebar-header">
            <h1 style={{fontSize:'1.5rem',fontWeight:'700',marginBottom:'0.5rem'}}>üè† RepZone V2</h1>
            <div style={{display:'flex',alignItems:'center',gap:'0.75rem',padding:'1rem',background:'#f8fafc',borderRadius:'0.75rem'}}>
              <div style={{width:'40px',height:'40px',borderRadius:'50%',background:currentUser.color,display:'flex',alignItems:'center',justifyContent:'center',color:'white',fontWeight:'bold'}}>{currentUser.name.charAt(0)}</div>
              <div style={{flex:1}}>
                <div style={{fontWeight:'600'}}>{currentUser.name}</div>
                <div style={{fontSize:'0.75rem',color:'#64748b'}}>{currentUser.role}</div>
              </div>
              <button onClick={() => { setCurrentUser(null); localStorage.removeItem('rz_user'); }} style={{padding:'0.5rem 1rem',background:'#e5e7eb',border:'none',borderRadius:'0.5rem',fontSize:'0.875rem',fontWeight:'600',cursor:'pointer'}}>Switch</button>
            </div>
          </div>

          <div className="sidebar-content">
            {isAdmin && (
              <div style={{marginBottom:'1rem'}}>
                <h3 style={{fontSize:'1rem',fontWeight:'600',marginBottom:'0.75rem'}}>üéØ Mode</h3>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem'}}>
                  <button onClick={() => setMode('view')} className="btn" style={{background: mode === 'view' ? '#eff6ff' : '#f8fafc', color: mode === 'view' ? '#3b82f6' : '#1e293b', border: mode === 'view' ? '2px solid #3b82f6' : '2px solid transparent'}}>üëÅÔ∏è View</button>
                  <button onClick={() => setMode('draw')} className="btn" style={{background: mode === 'draw' ? '#eff6ff' : '#f8fafc', color: mode === 'draw' ? '#3b82f6' : '#1e293b', border: mode === 'draw' ? '2px solid #3b82f6' : '2px solid transparent'}}>‚úèÔ∏è Draw</button>
                </div>
                
                {mode === 'draw' && zonePoints.length > 0 && (
                  <div style={{display:'flex',gap:'0.5rem',marginTop:'0.75rem'}}>
                    <button onClick={finishZone} className="btn btn-primary" style={{flex:1}}>‚úÖ Finish ({zonePoints.length})</button>
                    <button onClick={cancelDrawing} className="btn" style={{background:'#ef4444',color:'white'}}>‚úñ</button>
                  </div>
                )}
              </div>
            )}

            <div>
              <h3 style={{fontSize:'1rem',fontWeight:'600',marginBottom:'0.75rem'}}>
                üó∫Ô∏è Zones ({visibleZones.length})
                {!isAdmin && <span style={{fontSize:'0.75rem',color:'#64748b',fontWeight:'400',marginLeft:'0.5rem'}}>(Your zones)</span>}
              </h3>
              {visibleZones.map(zone => {
                const assignedUser = USERS.find(u => u.id === zone.assigned_to);
                return (
                  <div key={zone.id} className="zone-item" onClick={() => { if (isAdmin) { setSelectedZone(zone); setShowAssignModal(true); } }}>
                    <div style={{display:'flex',alignItems:'center',gap:'0.75rem'}}>
                      <span style={{width:'16px',height:'16px',borderRadius:'50%',background:zone.color}}></span>
                      <div>
                        <div style={{fontWeight:'700'}}>{zone.name}</div>
                        {assignedUser && <div style={{fontSize:'0.75rem',color:'#64748b'}}>üë§ {assignedUser.name}</div>}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
